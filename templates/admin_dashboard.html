{% extends "base.html" %}
{% block title %}Admin Dashboard | Dressly{% endblock %}
{% block content %}
<style>
  :root {
    --dark-blue: #0a1623;
    --navy-blue: #14213d;
    --midnight-blue: #1a2236;
    --accent-red: #e63946;
    --soft-white: #f1faee;
    --card-bg: #1a2236;
    --card-border: #e63946;
    --table-header: #e63946;
    --table-row: #14213d;
    --table-alt-row: #1a2236;
    --section-bg: #14213d;
    --section-border: #e63946;
    --button-bg: #e63946;
    --button-text: #fff;
  }
  body, .admin-bg {
    background: linear-gradient(135deg, var(--dark-blue) 0%, var(--navy-blue) 60%, var(--midnight-blue) 100%);
    min-height: 100vh;
    color: var(--soft-white);
  }
  .admin-container {
    max-width: 1300px;
    margin: 2.5rem auto;
    padding: 2.5rem 2rem;
    border-radius: 32px;
    background: var(--section-bg);
    box-shadow: 0 4px 24px rgba(20,33,61,0.18);
    display: flex;
    flex-direction: column;
    gap: 2.5rem;
  }
  .admin-section {
    background: var(--card-bg);
    border-radius: 22px;
    box-shadow: 0 4px 24px rgba(230,57,70,0.10);
    padding: 2rem 1.5rem 1.5rem 1.5rem;
    border-left: 8px solid var(--section-border);
    margin-bottom: 0.5rem;
    position: relative;
  }
  .admin-section h2 {
    color: var(--accent-red);
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 1.2rem;
    letter-spacing: 0.5px;
  }
  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 1.5rem;
  }
  .metric-card {
    background: var(--card-bg);
    border-radius: 16px;
    box-shadow: 0 2px 10px rgba(230,57,70,0.10);
    border: 2px solid var(--card-border);
    padding: 1.2rem 1.2rem 1.2rem 1.2rem;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    min-height: 120px;
    transition: box-shadow 0.2s, transform 0.2s;
  }
  .metric-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--accent-red);
    margin-bottom: 0.3rem;
  }
  .metric-value {
    font-size: 2.1rem;
    font-weight: 700;
    color: var(--accent-red);
    margin-bottom: 0.2rem;
  }
  .metric-desc {
    font-size: 0.98rem;
    color: var(--soft-white);
  }
  .table-responsive {
    margin-top: 1.2rem;
  }
  table {
    width: 100%;
    background: var(--table-row);
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 1px 8px rgba(20,33,61,0.08);
  }
  th, td {
    padding: 0.7rem 1rem;
    text-align: left;
    color: var(--soft-white);
    font-size: 1rem;
  }
  th {
    background: var(--table-header);
    color: #fff;
    font-weight: 600;
  }
  tr:nth-child(even) { background: var(--table-alt-row); }
  .users-table th, .users-table td {
    border-bottom: 1px solid var(--accent-red);
  }
</style>
<script>
// Fetch and render dashboard data (updated for flat backend structure)
function renderDashboard(data) {
  // Product Engagement Metrics (flat)
  document.getElementById('mostViewedTitle').textContent = data.most_viewed_product ? data.most_viewed_product.title : '-';
  document.getElementById('mostViewedCount').textContent = data.most_viewed_product ? data.most_viewed_product.views : '-';

  // Most Added to Cart Product
  document.getElementById('mostAddedTitle').textContent = data.most_added_product ? data.most_added_product.title : '-';
  document.getElementById('mostAddedCount').textContent = data.most_added_product ? data.most_added_product.add_to_cart : '-';

  // Highest Conversion Rate Product
  document.getElementById('highestConversionTitle').textContent = data.highest_conversion_product ? data.highest_conversion_product.title : '-';
  document.getElementById('highestConversionRate').textContent = data.highest_conversion_product && data.highest_conversion_product.conversion_rate !== undefined
    ? (Math.round(data.highest_conversion_product.conversion_rate * 10000) / 100).toFixed(2) + '%' : '-';

  // Hide or clear other product engagement metrics (not available)
  document.getElementById('topRatedTitle').textContent = '-';
  document.getElementById('topRatedValue').textContent = '-';

  // Product Engagement Table: show only most viewed if available
  const engagementTable = document.getElementById('engagementTable').querySelector('tbody');
  engagementTable.innerHTML = '';
  if (data.most_viewed_product) {
    const row = data.most_viewed_product;
    engagementTable.innerHTML += `<tr>
      <td>${row.title}</td>
      <td>${row.views}</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
      <td>-</td>
    </tr>`;
  }

  // User Behavior Metrics (not available)
  document.getElementById('mostActiveUser').textContent = '-';
  document.getElementById('mostActiveCount').textContent = '-';
  document.getElementById('topBuyer').textContent = '-';
  document.getElementById('topBuyerCount').textContent = '-';
  document.getElementById('mostViewedCategory').textContent = '-';
  document.getElementById('mostPopularSegment').textContent = '-';

  // User Table (empty)
  const userTable = document.getElementById('userTable').querySelector('tbody');
  userTable.innerHTML = '';

  // Sales Table (empty)
  const salesTable = document.getElementById('salesTable').querySelector('tbody');
  salesTable.innerHTML = '';
  document.getElementById('topSeller').textContent = '-';
  document.getElementById('repeatRate').textContent = '-';
  document.getElementById('abandonedRate').textContent = '-';

  // Marketing Table (empty)
  const marketingTable = document.getElementById('marketingTable').querySelector('tbody');
  marketingTable.innerHTML = '';
  document.getElementById('mostClickedAd').textContent = '-';
  document.getElementById('mostUsedCoupon').textContent = '-';
  document.getElementById('mostClickedRec').textContent = '-';

  // Registered Users Table
  const usersTable = document.querySelector('.users-table tbody');
  usersTable.innerHTML = '';
  if (data.registered_users && Array.isArray(data.registered_users)) {
    data.registered_users.forEach(user => {
      usersTable.innerHTML += `<tr>
        <td>${user.id}</td>
        <td>${user.username}</td>
        <td>${user.email}</td>
        <td>${user.role}</td>
      </tr>`;
    });
  }

  // Customer Segmentation Table
  const segTable = document.getElementById('customerSegmentationTable').querySelector('tbody');
  segTable.innerHTML = '';
  if (data.clustered_customers && Array.isArray(data.clustered_customers)) {
    data.clustered_customers.forEach(row => {
      segTable.innerHTML += `<tr>
        <td>${row.CustomerID}</td>
        <td>${row.Gender}</td>
        <td>${row.Age}</td>
        <td>${row['Annual Income (k$)']}</td>
        <td>${row['Spending Score (1-100)']}</td>
        <td>${row.Cluster}</td>
      </tr>`;
    });
  }

  // Ads Table
  const adsTable = document.querySelector('.ads-table tbody');
  adsTable.innerHTML = '';
  if (data.ads && Array.isArray(data.ads)) {
    data.ads.forEach(ad => {
      adsTable.innerHTML += `<tr>
        <td>${ad.id}</td>
        <td>${ad.product_id}</td>
        <td>${ad.title}</td>
        <td>${ad.description}</td>
        <td><img src="${ad.image}" alt="Ad Image" style="width:40px;height:60px;object-fit:cover;border-radius:4px;"/></td>
        <td>${ad.target_segment}</td>
        <td>${ad.start_date || ''}</td>
        <td>${ad.end_date || ''}</td>
        <td>${ad.is_active ? 'Yes' : 'No'}</td>
      </tr>`;
    });
  }
}

// Fetch dashboard data on load
function fetchDashboardData() {
  fetch('/admin_dashboard_data')
    .then(res => res.json())
    .then(data => renderDashboard(data))
    .catch(err => {
      console.error('Failed to fetch admin dashboard data:', err);
      alert('Failed to load dashboard data.');
    });
}
document.addEventListener('DOMContentLoaded', fetchDashboardData);
</script>
<style>
  @media (max-width: 900px) {
    .admin-container { padding: 1.2rem 0.5rem; }
    .metrics-grid { grid-template-columns: 1fr; }
    .admin-section { padding: 1.2rem 0.5rem 1rem 0.5rem; }
    th, td { font-size: 0.95rem; padding: 0.5rem 0.5rem; }
  }
</style>
<div class="admin-bg">
  <div class="admin-container">
    <!-- 1. Product Engagement -->
    <section class="admin-section">
      <h2>Product Engagement
        <span id="toggleEngagementTableBtn" style="cursor:pointer;float:right;font-size:1.3rem;user-select:none;" title="Show/Hide Table">Show Table &#9660;</span>
      </h2>
      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-title">Most Viewed Product</div>
          <div class="metric-value" id="mostViewedTitle">-</div>
          <div class="metric-desc">Total Views: <span id="mostViewedCount">-</span></div>
        </div>
        <div class="metric-card">
          <div class="metric-title">Highest Conversion Rate</div>
          <div class="metric-value" id="highestConversionTitle">-</div>
          <div class="metric-desc">Rate: <span id="highestConversionRate">-</span></div>
        </div>
        <div class="metric-card">
          <div class="metric-title">Most Added to Cart</div>
          <div class="metric-value" id="mostAddedTitle">-</div>
          <div class="metric-desc">Add Count: <span id="mostAddedCount">-</span></div>
        </div>
        <div class="metric-card">
          <div class="metric-title">Top Rated Product</div>
          <div class="metric-value">{{ top_rated.title if top_rated else '-' }}</div>
          <div class="metric-desc">Avg Rating: <span>{{ '%.2f' % top_rated.avg_rating if top_rated and top_rated.avg_rating != None else '-' }}</span></div>
        </div>
      </div>
      <div class="table-responsive">
        <div id="engagementTableWrapper">
          <table id="engagementTable">
            <thead>
              <tr>
                <th>Product</th>
                <th>Views</th>
                <th>Avg Rating</th>
                <th>Add to Cart</th>
                <th>Purchases</th>
                <th>Rating Count</th>
              </tr>
            </thead>
            <tbody>
              {% for row in engagement %}
              <tr>
                <td>{{ row.title }}</td>
                <td>{{ row.views }}</td>
                <td>{{ '%.2f' % row.avg_rating if row.avg_rating != None else '-' }}</td>
                <td>{{ row.add_to_cart }}</td>
                <td>{{ row.purchases }}</td>
                <td>{{ row.rating_count }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </section>
    <!-- 2. User Behavior -->
    <section class="admin-section">
      <h2>User Behavior</h2>
      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-title">Most Active User</div>
          <div class="metric-value">{{ most_active_user.username if most_active_user else '-' }}</div>
          <div class="metric-desc">Activity Count: {{ most_active_user.activity_count if most_active_user else '-' }}</div>
        </div>
        <div class="metric-card">
          <div class="metric-title">Top Buyer</div>
          <div class="metric-value">{{ top_buyer.username if top_buyer else '-' }}</div>
          <div class="metric-desc">Purchases: {{ top_buyer.purchases if top_buyer else '-' }}</div>
        </div>
        <div class="metric-card">
          <div class="metric-title">Most Viewed Category</div>
          <div class="metric-value">{{ most_viewed_category.category if most_viewed_category else '-' }}</div>
          <div class="metric-desc">Views: {{ most_viewed_category.total_views if most_viewed_category else '-' }}</div>
        </div>
        <div class="metric-card">
          <div class="metric-title">Most Popular Segment</div>
          <div class="metric-value">{{ most_popular_segment['category'] if most_popular_segment and most_popular_segment['category'] else '-' }}</div>
          <div class="metric-desc">Users: {{ most_popular_segment['user_count'] if most_popular_segment and most_popular_segment['user_count'] else '-' }}</div>
        </div>
      </div>
      <div class="table-responsive">
        <!-- User Behavior table removed as requested -->
      </div>
    </section>
    <!-- 3. Sales & Trends -->
    <section class="admin-section">
      <h2>Sales & Trends</h2>
      <div style="display:flex;justify-content:space-between;align-items:center;">
  <div></div>
  <span id="toggleSalesTableBtn" style="cursor:pointer;font-size:1.3rem;font-weight:700;color:var(--accent-red);user-select:none;" title="Show/Hide Table">Show Table &#9660;</span>
      </div>
      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-title">Top Seller</div>
          <div class="metric-value">{{ top_seller.title if top_seller else '-' }}</div>
          <div class="metric-desc">Units Sold: {{ top_seller.total_sold if top_seller else '-' }}</div>
        </div>
        <div class="metric-card">
          <div class="metric-title">Repeat Purchase Rate</div>
          <div class="metric-value">{{ repeat_purchase_rate }}%</div>
          <div class="metric-desc">% of users with >1 order</div>
        </div>
        <div class="metric-card">
          <div class="metric-title">Abandoned Cart Rate</div>
          <div class="metric-value">{{ abandoned_cart_rate if abandoned_cart_rate is not none else '-' }}%</div>
          <div class="metric-desc">% of carts not ordered</div>
        </div>
      </div>
  <div class="table-responsive" id="salesTableWrapper" style="display:none;">
        <table id="salesTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Sales</th>
            </tr>
          </thead>
          <tbody>
            {% for row in sales_trends %}
            <tr>
              <td>{{ row.date }}</td>
              <td>{{ row.sales }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

<script>
// Collapsible logic for sales & trends table (Product Engagement style)
document.addEventListener('DOMContentLoaded', function() {
  var btn = document.getElementById('toggleSalesTableBtn');
  var wrapper = document.getElementById('salesTableWrapper');
  var arrowDown = 'Show Table &#9660;';
  var arrowUp = 'Hide Table &#9650;';
  btn.innerHTML = arrowDown;
  btn.onclick = function() {
    if (wrapper.style.display === 'none' || wrapper.style.display === '') {
      wrapper.style.display = 'block';
      btn.innerHTML = arrowUp;
    } else {
      wrapper.style.display = 'none';
      btn.innerHTML = arrowDown;
    }
  };
});
</script>
    </section>
    <!-- Users Table Section (Collapsible) -->
    <section class="admin-section">
      <h2>Registered Users</h2>
      <button id="toggleUsersTable" style="background:var(--accent2);color:#fff;padding:0.7rem 1.5rem;border:none;border-radius:8px;font-weight:700;font-size:1rem;cursor:pointer;margin-bottom:1rem;">Show Table ▼</button>
      <div class="table-responsive" id="usersTableContainer" style="display:none;">
        <table class="users-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Username</th>
              <th>Email</th>
              <th>Role</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
            <tr>
              <td>{{ user.id }}</td>
              <td>{{ user.username }}</td>
              <td>{{ user.email }}</td>
              <td>{{ user.role }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
    <!-- End Users Table Section -->
    <!-- 5. Customer Segmentation Table (Collapsible) -->
    <section class="admin-section">
      <h2>Customer Segmentation</h2>
      <button id="toggleSegmentationTable" style="background:var(--accent2);color:#fff;padding:0.7rem 1.5rem;border:none;border-radius:8px;font-weight:700;font-size:1rem;cursor:pointer;margin-bottom:1rem;">Show Table ▼</button>
      <div class="table-responsive" id="segmentationTableContainer" style="display:none;">
        <table id="customerSegmentationTable">
          <thead>
            <tr>
              <th>CustomerID</th>
              <th>Gender</th>
              <th>Age</th>
              <th>Annual Income (k$)</th>
              <th>Spending Score (1-100)</th>
              <th>Cluster</th>
            </tr>
          </thead>
          <tbody>
            {% for row in clustered_customers %}
            <tr>
              <td>{{ row['CustomerID'] }}</td>
              <td>{{ row['Gender'] }}</td>
              <td>{{ row['Age'] }}</td>
              <td>{{ row['Annual Income (k$)'] }}</td>
              <td>{{ row['Spending Score (1-100)'] }}</td>
              <td>{{ row['Cluster'] }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
    <!-- End Customer Segmentation Table -->
    <!-- 6. Ads Table Section (Collapsible) -->
    <section class="admin-section">
      <h2>Ads Management</h2>
      <button id="toggleAdsTable" style="background:var(--accent2);color:#fff;padding:0.7rem 1.5rem;border:none;border-radius:8px;font-weight:700;font-size:1rem;cursor:pointer;margin-bottom:1rem;">Show Table ▼</button>
      <div class="table-responsive" id="adsTableContainer" style="display:none;">
        <table class="ads-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Product ID</th>
              <th>Title</th>
              <th>Description</th>
              <th>Image</th>
              <th>Target Segment</th>
              <th>Start Date</th>
              <th>End Date</th>
              <th>Active</th>
            </tr>
          </thead>
          <tbody>
            {% for ad in ads %}
            <tr>
              <td>{{ ad.id }}</td>
              <td>{{ ad.product_id }}</td>
              <td>{{ ad.title }}</td>
              <td>{{ ad.description }}</td>
              <td><img src="{{ ad.image }}" alt="Ad Image" style="width:40px;height:60px;object-fit:cover;border-radius:4px;"/></td>
              <td>{{ ad.target_segment }}</td>
              <td>{{ ad.start_date }}</td>
              <td>{{ ad.end_date }}</td>
              <td>{{ 'Yes' if ad.is_active else 'No' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>
    <!-- End Ads Table Section -->
  </div>
</div>
<script>
// Collapsible logic for users table
const toggleUsersBtn = document.getElementById('toggleUsersTable');
const usersTableContainer = document.getElementById('usersTableContainer');
toggleUsersBtn.addEventListener('click', function() {
  if (usersTableContainer.style.display === 'none') {
    usersTableContainer.style.display = 'block';
    toggleUsersBtn.textContent = 'Hide Table ▲';
  } else {
    usersTableContainer.style.display = 'none';
    toggleUsersBtn.textContent = 'Show Table ▼';
  }
});
// Collapsible logic for segmentation table
const toggleBtn = document.getElementById('toggleSegmentationTable');
const segTableContainer = document.getElementById('segmentationTableContainer');
toggleBtn.addEventListener('click', function() {
  if (segTableContainer.style.display === 'none') {
    segTableContainer.style.display = 'block';
    toggleBtn.textContent = 'Hide Table ▲';
  } else {
    segTableContainer.style.display = 'none';
    toggleBtn.textContent = 'Show Table ▼';
  }
});
// Collapsible logic for ads table
const toggleAdsBtn = document.getElementById('toggleAdsTable');
const adsTableContainer = document.getElementById('adsTableContainer');
toggleAdsBtn.addEventListener('click', function() {
  if (adsTableContainer.style.display === 'none') {
    adsTableContainer.style.display = 'block';
    toggleAdsBtn.textContent = 'Hide Table ▲';
  } else {
    adsTableContainer.style.display = 'none';
    toggleAdsBtn.textContent = 'Show Table ▼';
  }
});
// Collapsible engagement table logic
  document.addEventListener('DOMContentLoaded', function() {
    var btn = document.getElementById('toggleEngagementTableBtn');
    var wrapper = document.getElementById('engagementTableWrapper');
    var arrowDown = 'Show Table \u25BC';
    var arrowUp = 'Hide Table \u25B2';
    btn.innerHTML = arrowDown;
    btn.onclick = function() {
      if (wrapper.style.display === 'none') {
        wrapper.style.display = '';
        btn.innerHTML = arrowDown;
      } else {
        wrapper.style.display = 'none';
        btn.innerHTML = arrowUp;
      }
    };
  });
// Collapsible table logic
  document.addEventListener('DOMContentLoaded', function() {
    var btn = document.getElementById('toggleTableBtn');
    var wrapper = document.getElementById('engagementTableWrapper');
    var arrowDown = '\u25BC';
    var arrowUp = '\u25B2';
    btn.innerHTML = arrowDown;
    btn.onclick = function() {
      if (wrapper.style.display === 'none') {
        wrapper.style.display = '';
        btn.innerHTML = arrowDown;
      } else {
        wrapper.style.display = 'none';
        btn.innerHTML = arrowUp;
      }
    };
  });
</script>
{% endblock %}

